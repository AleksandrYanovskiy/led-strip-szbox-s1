# led-strip-szbox-s1
[English](./README.md)
| ***Русский***
___
Решение проблемы с неработающей LED подсветкой на мини ПК **SZBOX S1** (ACEMAGIC S1)
___
## 1. Предыстория
При выборе сервера для PROXMOX, был выбран мини ПК **SZBOX S1 Intel Alder Lake N97** (копия **ACEMAGIC S1**) на Aliexpress.

<div>
  <p align="center">
    <img src="images/szbox-s1.png" alt="мини ПК SZBOX S1" data-canonical-src="images/szbox-s1.png" width="300" />
    <img src="images/acemagic-s1.png" alt="мини ПК ACEMAGIC S1" data-canonical-src="images/acemagic-s1.png" width="300" />
    <br>
    <em>SZBOX S1 и ACEMAGIC S1</em>
  </p>
</div>
<br>

ПК без проблем поддерживает объем памяти до 32Гб, несмотря на то, что в описании было указано максимально только 16Гб.\
Так же наличие информационного дисплея делало этот ПК просто незаменимым для домашнего сервера.

Благодаря проекту [AceMagic-S1-LED-TFT-Linux](https://github.com/tjaworski/AceMagic-S1-LED-TFT-Linux) (огромное спасибо автору!) дисплей и нижняя подсветка LED заработали в Linux без проблем.\
Но, к сожалению,  через несколько месяцев появилась неисправность - перестала работать подсветка LED.

___
## 2. Можно починить?
Возникла идея починить неработающую LED подсветку.\
Был разобран корпус, и извлечен модуль LED для его проверки.\
Модуль содержит 6 адресных RGB светодиодов, и пассивные элементы, в виде резистора и нескольких конденсаторов.\
По сути модуль не содержит управляющих элементов, это просто набор адресных RGB светодиодов.
<div>
  <p>
    <img src="images/led-strip-1.png" alt="LED модуль" data-canonical-src="images/led-strip-1.png" width="400" />
    <br>
    <em>LED модуль</em>
  </p>
  <p>
    <img src="images/led-strip-2.png" alt="LED модуль без верхней крышки" data-canonical-src="images/led-strip-2.png" width="400" />
    <br>
    <em>LED модуль без верхней крышки</em>
  </p>
  <p>
    <img src="images/led-strip-3.png" alt="LED модуль с обратной стороны" data-canonical-src="images/led-strip-3.png" width="400" />
    <br>
    <em>LED модуль и TFT экран с обратной стороны</em>
  </p>
</div>
<br>

Оказалось, что он подключается к основной плате через разъем, который можно отключить и снять модуль полностью.\
Модуль был подключен к другому мини ПК - и модуль подсветки оказался рабочим.

Была попытка проанализировать схему управления модулем LED.\
Модуль питается от +5В, и имеет один управляющий вывод.

Выяснилось, что управляющий вывод подключен к микросхеме, не имеющей маркировки 
(кроме буквы B, там где ключ на корпусе 1-го вывода).\
Микросхема находится на плате около кнопки включения питания, под радиатором и имеет номер **U31**:
<div>
  <p>
    <img src="images/board-1.png" alt="Неопознанная микросхема и микросхема UART" data-canonical-src="images/board-1.png" width="400" />
    <br>
    <em>Слева микросхема управления LED модулем и микросхема UART</em>
  </p>
  <p>
    <img src="images/u31.png" alt="Неопознанная микросхема U31" data-canonical-src="images/u31.png" width="400" />
    <br>
    <em>Неопознанная микросхема U31</em>
  </p>
</div>
<br>

Вывод микросхемы **U31-2** подключен к выводу модуля **LED-DIN**.\
Рядом находится микросхема **U3** - **CH340N** - **USB to UART TTL Converter**.

Схема подключения, которую получилось нарисовать с сигналами на рабочей микросхеме:
<div>
  <img src="images/scheme-u31.png" alt="scheme-u31" data-canonical-src="images/scheme-u31.png" width="400" />
</div>

На неисправной микросхеме **U31** нет сигналов на следующих выводах:\
**2, 3, 5, 6**.

Выяснилось, что эта микросхема является или микроконтроллером, или специальной микросхемой, которая выполняет следующие функции:
* при включении питания - она генерирует сигнал на выводе 2, и LED подсветка начинает работать по первоначальному алгоритму, даже если в ПК нет дисков и памяти.
* микросхеме можно указать режим работы LED, путем отправки через UART команды, определенного вида, которые она получает на выводе 7, который подключен к микросхеме **U3-6(TXD)**.

Назначение MOSFET **Q19** и **Q98** установить не удалось.\
Ясно одно - для светодиодов RGB транзисторы не нужны - они не потребляют столько тока, чтобы их коммутировать через эти MOSFET-ключи.

На всех выводах мультиметром в режиме проверки диодов наблюдается одинаковое падение напряжения, как и на работающей **U3**.\
3-й вывод вызывает вопрос: это выход или вход? Найти не удалось, куда он подключен на плате.\
Возможно, что наличие на нем +5 В включает микросхему.

К сожалению, поиск микросхемы по указанным подключениям оказался безрезультатным.

___
## 3. Что делать?
Так как найти принципиальную схему, на мини ПК не удалось, возник вопрос - можно ли восстановить работу LED модуля другим способом?\
Есть простой Arduino совместимый модуль с **Attiny85**, под названием **Digispark**.\
С разъемом подключения USB-micro:
<div>
  <img src="images/digispark-micro.png" alt="Digispark с разъемом mico-usb" data-canonical-src="images/digispark-micro.png" width="200" />
</div>

Эти модули бывают нескольких видов:
<div>
  <img src="images/digispark-var.png" alt="Варианты модулей Digispark" data-canonical-src="images/digispark-var.png" width="400" />
</div>
<br>

Модуль LED был подключен к **Digispark**, и, с помощью библиотеки **Adafruit's NeoPixel** модуль работал!

<div>
  <img src="images/led-work-1.png" alt="LED модуль горит желто-оранжевым светом" data-canonical-src="images/led_work-1.png" width="400" />
  <img src="images/led-work-2.png" alt="LED модуль горит сине-белым светом" data-canonical-src="images/led_work-2.png" width="400" />
</dev>

___
## 4. Схема

> :warning: **ДИСКЛЕЙМЕР**\
Вся предоставленная далее информация и программные файлы предназначены исключительно для ознакомительных целей и предоставляются без каких-либо гарантий. Доработки и вмешательства в работу вашего устройства могут привести к аннулированию гарантии, необратимым повреждениям оборудования или травмам. Автор не несет ответственности за любой ущерб вашему «железу», программам, имуществу и здоровью. Вы действуете на свой страх и риск. Все предложенные доработки предоставлены для ознакомления, и не являются обязательными для повторения. Всегда соблюдайте правила техники безопасности при работе с электроникой и убедитесь, что ваши действия соответствуют местным законам и стандартам безопасности.
___

Плата **Digispark** имеет следующие выводы:

<div>
  <img src="images/digispark-board-pinout-2.png" alt="Описание выводов Digispark" data-canonical-src="images/digispark-board-pinout-2.png" width="600" />
</div>
<br>

Питание с платы ПК подключается через штатный разъем **JST SH 3pin**.\
+5В подключается к выводу 5V через диод (красный провод на схеме далее).\
Общий вывод подключается к выводу GND (черный провод на схеме далее).\
Центральный вывод не подключен.

В скетче Arduino, описанном [далее](#5-arduino-скетч), обращение в коде идет по названиям выводов - `PB0`, `PB1` и т.д.\
Фактически в **Digispark** можно использовать только выводы `PB0 PB1 PB2`.\
Вывод `PB1`, в данном случае, подключен в светодиоду на плате **Digispark**, поэтому было решено использовать его как вывод для управления LED модулем - видно активность посылаемых команд. Вывод `PB2` используется для чтения данных с UART, вывод `PB0` можно использовать для отправки отладочных данных на UART.

### Вариант 1
Самый простой вариант доработки.
<details>
  <summary>Схема и описание</summary>
  <br>
  Не требуется вмешательства в электронику ПК, разборка мини ПК не понадобится - достаточно снять боковую крышку на магнитах.
  <br>
  <br>

  > :exclamation:
  Для работы LED модуля его необязательно подключать к UART. Программный код по-умолчанию настроен на режим перебора всех RGB эффектов по очереди и для работы дополнительные команды, посылаемые из UART ему не нужны. В скетче может быть выбран любой режим, который будет бесконечно повторяться. Следовательно, подключение к выводам `PB0` и `PB2` можно не делать и обойтись без пайки на плате мини ПК.

  <div>
    <p align="center">
      <img src="images/chematic-diagram-1.png" alt="Схема 1-й вариант" data-canonical-src="images/chematic-diagram-1.png" width="800" />
      <br>
      <em>Схема подключения вар.1</em>
    </p>
  </div>
  <br>

  Модуль **Digispark** подключается между модулем LED и платой ПК. Для этого применяются разъемы **JST-SH 3pin 1mm (male | female)**.
  <div>
    <p>
      <img src="images/jst-sh-3p.png" alt="Разъем Jst-sh-3p" data-canonical-src="images/jst-sh-3p.png" width="150" />
      <br>
      <em>Разъем JST SH 3PIN</em>
    </p>
    <p>
      <img src="images/led-connector.png" alt="Разъем подключения LED модуля" data-canonical-src="images/led-connector.png" width="400" />
      <br>
      <em>Разъем подключения LED модуля (слева)</em>
    </p>
  </div>
  <br>

  В разъеме с тремя выводами, который идет от **Digispark** и подключается к плате ПК, необходимо убрать средний контакт. Так же необходимо добавить диод Шоттки, с минимальным падением напряжения на нём, в разрыв провода питания, если планируется в дальнейшем подключать модуль **Digispark** к ПК с Arduino для его прошивки. Это защита от подачи напряжения на мини ПК через модуль **Digispark**. 

</details>

### Вариант 2
Вариант по-сложнее.
<details>
  <summary>Схема и описание</summary>
  <br>
    Необходима разборка мини ПК со снятием радиатора, и пайка к одному контакту микросхемы UART.
  <br>
  <br>

  > :exclamation: **Пояснение по работе с UART:**\
  Подключение к **UART** нужно для того, чтобы можно было программно устанавливать нужный  режим работы модуля LED. (см. [AceMagic-S1-LED-TFT-Linux](https://github.com/tjaworski/AceMagic-S1-LED-TFT-Linux)). Для этого используется вывод `PB2` **Digispark**.

  <div>
  <p align="center">
    <img src="images/chematic-diagram-2.png" alt="Схема 2-й вариант" data-canonical-src="images/chematic-diagram-2.png" width="800" />
    <br>
    <em>Схема подключения вар.2</em>
  </p>
  </div>

  Подключение к **U3** с резистором выглядит так:

  <div>
    <p>
      <img src="images/connect-1.png" alt="Провод с резистором" data-canonical-src="images/connect-1.png" width="400" />
    </p>
    <p>
      <img src="images/connect-2.png" alt="Провод с резистором подключен к микросхеме" data-canonical-src="images/connect-2.png" width="400" />
    </p>
    <p>
      <img src="images/connect-3.png" alt="Общий вид подключения к плате" data-canonical-src="images/connect-3.png" width="400" />
    </p>
  </div>
  <br>

  > :exclamation:
  > На изображении показано, что провод с резистором подключен к микросхеме **U31**, а не к **U3**. Сделано это просто для удобства, так как вывод **U31-7** физически подключен к выводу **U3-6(TXD)**.

  Резисторы на контактах `PB0` и `PB2` нужны для ограничения тока, в случае конфликта сигналов на микросхеме **U3** и модуля **Digispark**.

  Подключение к **U3**, которая является **CH340N - USB to UART TTL Converter** сделано путем пайки провода к выводу **6** микросхемы на плате мини ПК.

  <div>
    <img src="images/ch340n.png" alt="ch340n" data-canonical-src="images/ch340n.png" width="300" />
  </div>
  <br>

  Эта микросхема подключена к USB порту на плате.\
  Определяется как устройство **ID 1a86:7523 CH340 serial converter** и используется для программной установки режимов LED панели.

  Если отсутствует желание что-то паять на плате мини ПК, а управлять эффектами очень хочется, то можно использовать внешний USB-UART модуль +5V, который подключается к любому USB-порту мини ПК, и уже от него отдельным проводом от вывода **TXD** подключается к **Digispark**.

  Например такой, или аналогичный:
  <div>
    <img src="images/usb-uart.png" alt="usb-uart внешний модуль" data-canonical-src="images/usb-uart.png" width="200" />
    </div>
  <br>
</details>

### Вариант 3
Этот вариант служит для отладки модуля **Digisdpark**.
<details>
  <summary>Схема и описание</summary>
  <br>

  <div>
    <p align="center">
      <img src="images/chematic-diagram-3.png" alt="Схема 3-й вариант" data-canonical-src="images/chematic-diagram-3.png" width="800" />
      <br>
      <em>Схема подключения вар.3</em>
    </p>
  </div>
  <br>

  Для чтения отлаживаемой информации из **Digispark** модуля, должен быть припаян еще один провод с резистором к микросхеме UART.

  Вывод `PB0` используется для отладки скетча - вывода информации отладки, и в работе установки режимов работы LED модуля не участвует.

  <br>

  <div>
    <p>
      <img src="images/connect-4.png" alt="Провод с двумя резисторами" data-canonical-src="images/connect-4.png" width="400" />
      <br>
      <em>Подключение к <b>U3</b> с двумя резисторами</em>
    </p>
    <br>
    <p>
      <img src="images/connect-5.png" alt="Общий вид подключенного модуля Digispark" data-canonical-src="images/connect-5.png" width="400" />
      <br>
      <em>Общий вид подключенного модуля <b>Digispark</b></em>
    </p>
    <br>
    <p>
      <img src="images/connect-6.png" alt="Подключенный модуль Digispark в термоусадке" data-canonical-src="images/connect-6.png" width="400" />
      <br>
      <em>Подключенный модуль Digispark в термоусадке <b>Digispark</b></em>
    </p>
  </div>
  <br>
</details>

___
## 5. ARDUINO скетч
Для прошивки **Digispark** используется Arduino IDE.\
Для настройки **Arduino IDE** используется [ATTinyCore](https://github.com/felias-fogg/ATTinyCore/blob/classic-debug-enabled/Installation.md).

Настройки параметров **Digispark**:
<div>
  <p>
    <img src="images/arduino-01.png" alt="Выбор платы Digispark" data-canonical-src="images/arduino-01.png" width="400" />
    <br>
    <em>Выбор Digispark</em>
  </p>
  <br>
  <p>
    <img src="images/arduino-02.png" alt="Настройка частоты CPU" data-canonical-src="images/arduino-02.png" width="400" />
    <br>
    <em>Настройка частоты CPU</em>
  </p>
  <br>
  <p>
    <img src="images/arduino-03.png" alt="Настройка таймера" data-canonical-src="images/arduino-03.png" width="400" />
    <br>
    <em>Настройка таймера</em>
  </p>
</div>
<br>

Так же необходимо в **Arduino IDE** добавить библиотеку **Adafruit Neopixel**:
<div>
  <p>
    <img src="images/arduino-04.png" alt="Библиотека Adafruit Neopixel" data-canonical-src="images/arduino-04.png" width="400" />
    <br>
    <em>Библиотека Adafruit Neopixel</em>
  </p>
  <br>
</div>

Загрузчик **Digispark** работает по другому принципу, чем, например, плата **Arduino UNO**.\
При подаче питания на плату **Digispark** она сразу переходит в режим bootloader, и ожидает загрузки скетча в течении 60сек.\
Об этом будет надпись в окне Вывода **Arduino IDE** перед прошивкой.\
После загрузки, если она была, или после таймаута 60 сек начинает работать сам скетч.\
Поэтому включение LED подсветки после включения мини ПК будет происходить с небольшой задержкой.

В скетче есть детальное описание его работы.\
Сделана попытка реализации работы заводских режимов LED подсветки, и добавлено несколько дополнительных.

Скорость работы с **UART** выбрана `4800`, как самая стабильная. Плата может работать и на `9600`, но не всегда 100% распознает команды.\
Кстати, оригинальный **UART** LED подсветки на скорости `9600` тоже работает не стабильно.\
Скорость работы с **UART** можно поменять (_SERIAL_SPEED_).

В коде предусмотрена работа также с платой **Arduino UNO** и +5В лентой **WS2812B** из 6-ти светодиодов, для отладки и проверки режимов работы.\
В этом случае, в качестве **UART**, используется стандартный Serial объект.

Как уже было указано [выше](#вариант-1) - модуль **Digispark** может работать с LED подсветкой без **UART**. По-умолчанию он, при включении, будет перебирать все запрограммированные эффекты в цикле.

___
## 6. Итог
В результате проделанной модернизации, LED подсветка снова работает:
<div>
  <p>
    <img src="images/result.png" alt="LED подсветка (слева) снова работает" data-canonical-src="images/result.png" width="400" />
    <br>
    <em>LED подсветка (слева) снова работает</em>
  </p>
</div>
<br>

Возможно, существует и другое решение проблемы с работой LED подсветки.\
Всегда есть возможность вернуть "как было" - отключением модуля **Digispark**.\
Из плюсов - появилась возможность добавить любой RGB эффект самостоятельно.